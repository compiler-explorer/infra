name: Scheduled Windows Nightly Library Builds

on:
  schedule:
    # Run at 09:00 UTC daily (offset from regular Windows builds at 15:00 UTC)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      library_filter:
        description: 'Library filter (default: libraries/c++/nightly)'
        required: false
        default: 'libraries/c++/nightly'
        type: string

jobs:
  discover-libraries:
    if: github.repository == 'compiler-explorer/infra'
    runs-on: ubuntu-latest
    outputs:
      libraries: ${{ steps.get-libs.outputs.libraries }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python environment
        run: make ce

      - name: Get list of nightly libraries to build
        id: get-libs
        run: |
          FILTER="${{ github.event.inputs.library_filter || 'libraries/c++/nightly' }}"

          # Get the library names, with --per-lib for deduplication
          LIBS=$(bin/ce_install --enable nightly list-gh-build-commands --per-lib "$FILTER" | \
                 grep -o 'library=[^"]*' | \
                 cut -d= -f2 | \
                 sort -u)

          # Convert to JSON array for matrix strategy
          LIBS_JSON=$(echo "$LIBS" | jq -R -s -c 'split("\n")[:-1]')

          echo "libraries=$LIBS_JSON" >> $GITHUB_OUTPUT
          echo "Found nightly libraries to build:"
          echo "$LIBS" | sed 's/^/  - /'

  build-libraries:
    needs: discover-libraries
    if: ${{ fromJson(needs.discover-libraries.outputs.libraries)[0] != null }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.discover-libraries.outputs.libraries) }}
      fail-fast: false
      max-parallel: 2  # Limit concurrent builds
    uses: ./.github/workflows/win-lib-build.yaml
    with:
      library: ${{ matrix.library }}
      compiler: 'popular-compilers-only'
    secrets: inherit
